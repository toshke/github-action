'use strict';

const logger = require('./logger')();
const index = require('..');
const fs = require('fs')

function handleInput(input, cb, userOptions) {
  logger.debug(input);
  logger.debug(`user options ${userOptions}`);
  index.getOptions((err, options) => {
    if (err) {
      logger.error('error from getOptions');
      cb(err);
      return;
    }

    logger.debug(options);
    console.log(`Using lcov file: ${input.path} with format ${input.format}`);
    if (input.format == 'lcov') {
      index.convertLcovToCoveralls(input.path, options, (err, postData) => {
        if (err) {
          logger.error('error from convertLcovToCoveralls');
          cb(err);
          return;
        }

        logger.info('sending this to coveralls.io: ', JSON.stringify(postData));
        index.sendToCoveralls(postData, (err, response, body) => {
          if (err) {
            cb(err);
            return;
          }

          if (response.statusCode >= 400) {
            cb(`Bad response: ${response.statusCode} ${body}`);
            return;
          }

          logger.debug(response.statusCode);
          logger.debug(body);
          cb(null, body);
        });
      });
    }

    if (input.format == 'coveralls') {
        console.log(`Using coveralls format`);
        postData = JSON.parse(fs.readFileSync(input.path));
        index.sendToCoveralls(postData, (err, response, body) => {
          console.log(`Status from coveralls: ${response.statusCode}`)
          if (err) {
            cb(err);
            return;
          }
          
          if (response.statusCode >= 400) {
            cb(`Bad response: ${response.statusCode} ${body}`);
            return;
          }

          logger.debug(response.statusCode);
          logger.debug(body);
          cb(null, body);
        });
    }

  }, userOptions);
}

module.exports = handleInput;
